# 매매 전략 구조

이 디렉토리는 두 가지 타입의 전략을 포함합니다:
1. **백테스트 전략** (`BacktestStrategy` 상속) - 과거 데이터로 전략 성능 검증 (동기)
2. **실시간 거래 전략** (`TradingStrategy` 상속) - 실시간 매매 신호 생성 (비동기)

## 파일 구조

```
base_strategy.py                    # 백테스트 전략 베이스
├── ema_strategy.py                 # EMA 골든크로스 백테스트
├── ichimoku_strategy.py            # 일목균형표 백테스트
└── single_ema_backtest_strategy.py # 단일 20EMA 백테스트

base_trading_strategy.py            # 실시간 거래 전략 베이스
└── single_ema_strategy.py          # 단일 20EMA 실전 전략

trading_strategy_factory.py         # 실시간 전략 팩토리
strategy_factory.py                 # 백테스트 전략 팩토리 (상위 디렉토리)
```

## SWING_TYPE 매핑

| SWING_TYPE | 백테스트 전략 | 실시간 거래 전략 |
|------------|---------------|------------------|
| A | EMAStrategy | SingleEMAStrategy |
| B | IchimokuStrategy | SingleEMAStrategy (TODO) |
| C | SingleEMABacktestStrategy | SingleEMAStrategy |

---

## 단일 20EMA 실전 전략 (SingleEMAStrategy)

20일 지수이동평균(EMA)을 중심으로 추세 추종 매매를 수행하는 전략입니다.
분할 매수/매도를 지원하며, 장중 즉시 매도와 장 마감 매도를 이원화한 하이브리드 매도 로직을 사용합니다.

### 사용 지표

| 지표 | 용도 |
|-----|------|
| EMA 20 | 단기 추세 판단, 매수/매도 기준선 |
| EMA 120 | 장기 추세 판단, 하락장 필터 |
| ADX / +DI / -DI | 추세 강도 및 방향 판단 |
| ATR (14) | 변동성 기반 손절선, 가격 가드레일 |
| OBV z-score | 거래량 기반 수급 강도 |
| 외국인 순매수 비율 | 기관 수급 강도 |

### 배치 스케줄

| 시간 | 배치 | 설명 |
|-----|------|------|
| 08:29 | `ema_cache_warmup_job` | 지표 캐시 워밍업 (Redis) |
| 09:00~09:55 | `morning_sell_job` | 전일 확정된 매도 신호 실행 (SIGNAL 4/5) |
| 10:00~14:55 | `trade_job` | 장중 매수/손절 체크 (5분 간격) |
| 15:35 | `day_collect_job` | 당일 OHLCV 수집 + 종가 매도 신호 확정 |

### SIGNAL 상태 흐름

```
SIGNAL 0 (대기)
    │
    ├─ 1차 매수 조건 충족 ──→ SIGNAL 1 (1차 매수 완료)
    │                            │
    │                            ├─ 2차 매수 조건 충족 ──→ SIGNAL 2 (2차 매수 완료)
    │                            │                            │
    │                            │                            ├─ 장중 손절 ──→ SIGNAL 3 → SIGNAL 0
    │                            │                            └─ 종가 매도 확정 ──→ SIGNAL 4 또는 5
    │                            │
    │                            ├─ 장중 손절 ──→ SIGNAL 3 (1차 손절 매도) ──→ SIGNAL 0
    │                            └─ 종가 매도 확정 ──→ SIGNAL 4 또는 5
    │
    └─ SIGNAL 4 (1차 매도 대기) ──→ 다음날 시초 매도 ──→ SIGNAL 1 (잔량 보유)
       SIGNAL 5 (전량 매도 대기) ──→ 다음날 시초 매도 ──→ SIGNAL 0 (완전 청산)
```

---

### 매수 전략

#### 하락장 필터 (공통)

20 EMA가 120 EMA 아래에 있으면 하락장으로 판단하여 **1차, 2차 매수 모두 금지**합니다.

#### 1차 매수 조건

아래 5개 조건을 **모두 충족**하고, **연속 2회(10분)** 확인되어야 매수 신호가 발생합니다.

| 조건 | 기준 | 목적 |
|-----|------|------|
| EMA 추세 | 현재가 >= EMA20 * 0.995 | EMA 위에서 매수 (0.5% 여유) |
| 수급 강도 | 외국인 비율 >= 1.5% AND OBV z-score >= 1.0 | 기관+거래량 수급 확인 |
| 급등 필터 | 당일 상승률 <= 5% | 급등 추격매수 방지 |
| 괴리율 필터 | EMA 괴리율 <= 5% | 과열 구간 진입 방지 |
| 추세 방향 | +DI > -DI | 상승 추세 방향 확인 |

1차 매수 시 `buy_ratio%` 만큼 매수합니다 (예: 50%).

#### 2차 매수 조건

1차 매수 후 **최소 20분 경과** 시 아래 두 시나리오 중 하나가 충족되면 나머지 금액으로 추가 매수합니다.

**시나리오 A - 추세 강화형**

추세가 가속되는 상황에서 추가 진입합니다.

| 조건 | 기준 |
|-----|------|
| 가격 위치 | EMA + ATR x 0.3 ~ EMA + ATR x 2.0 |
| 추세 강도 | ADX > 25 |
| 추세 방향 | +DI > -DI |
| 수급 | 외국인 >= 1.5% AND OBV z-score >= 1.2 |

**시나리오 B - 눌림목 반등**

일시적 조정 후 반등하는 상황에서 추가 진입합니다.

| 조건 | 기준 |
|-----|------|
| 가격 위치 | EMA - ATR x 0.5 ~ EMA + ATR x 0.3 |
| 추세 강도 | 18 <= ADX <= 23 (조정 구간) |
| 추세 방향 | +DI > -DI |
| 수급 | 외국인 > 0.5% OR OBV z-score > 0.5 |
| 반등 확인 | 장중 저가 대비 0.4% 이상 반등 |

---

### 매도 전략 (이원화 하이브리드)

매도는 **장중 즉시 매도**와 **장 마감 매도** 두 단계로 나뉩니다.

#### [1차 방어선] 장중 즉시 매도

`trade_job`에서 5분마다 체크합니다. 급락 시 빠른 대응이 목적입니다.

| 조건 | 기준 | 동작 |
|-----|------|------|
| EMA-ATR 동적 손절 | 현재가 <= EMA - ATR x 1.0 | `sell_ratio%` 1차 매도 (SIGNAL 3) → 다음 주기에 잔량 전량 매도 (SIGNAL 0) |

#### [2차 방어선] 장 마감 매도

`day_collect_job`에서 매일 종가 확정 후 체크합니다. 노이즈를 제거한 추세 이탈 확정이 목적입니다.

**3가지 EOD 신호:**

| 신호 | 조건 | 유효 기간 |
|-----|------|----------|
| EMA 이탈 | 종가 < EMA20 | 3거래일 |
| 추세 약화 | ADX < 20 AND -DI > +DI (2일 연속) | 3거래일 |
| 수급 이탈 | 외국인 비율 < 1.0% OR OBV z-score < -1.0 | 3거래일 |

**1차 분할 매도 (SIGNAL 4)**

위 3개 신호 중 **2개 이상 충족** 시 → 다음날 시초에 `sell_ratio%` 매도, 잔량 보유 (SIGNAL 1)

**2차 전량 매도 (SIGNAL 5)**

1차 매도 상태에서 아래 조건 중 하나라도 충족 시 → 다음날 시초에 전량 매도 (SIGNAL 0)

- 3개 신호 **모두** 충족
- 1차 매도가 대비 **-2% 추가 하락**

---

### 전략 파라미터 요약

| 구분 | 파라미터 | 값 |
|-----|---------|-----|
| EMA | 단기 / 장기 | 20 / 120 |
| 1차 매수 | 외국인 비율 | >= 1.5% |
| 1차 매수 | OBV z-score | >= 1.0 |
| 1차 매수 | 급등 필터 | <= 5% |
| 1차 매수 | 괴리율 필터 | <= 5% |
| 1차 매수 | 연속 확인 | 2회 (10분) |
| 2차 매수 | 경과 시간 | >= 20분 |
| 2차 매수(A) | ADX | > 25 |
| 2차 매수(B) | ADX | 18~23 |
| 2차 매수(B) | 반등 비율 | 0.4% |
| 즉시 매도 | ATR 배수 | 1.0 |
| EOD 매도 | 신호 윈도우 | 3거래일 |
| EOD 매도 | 추세 약화 연속 | 2일 |
| 2차 전량 매도 | 추가 하락 | -2% |