# 매매 전략 구조

이 디렉토리는 두 가지 타입의 전략을 포함합니다:
1. **백테스트 전략** (`BacktestStrategy` 상속) - 과거 데이터로 전략 성능 검증 (동기)
2. **실시간 거래 전략** (`TradingStrategy` 상속) - 실시간 매매 신호 생성 (비동기)

## 파일 구조

```
base_strategy.py                    # 백테스트 전략 베이스
├── ema_strategy.py                 # EMA 골든크로스 백테스트
├── ichimoku_strategy.py            # 일목균형표 백테스트
└── single_ema_backtest_strategy.py # 단일 20EMA 백테스트

base_trading_strategy.py            # 실시간 거래 전략 베이스
└── single_ema_strategy.py          # 단일 20EMA 실전 전략

trading_strategy_factory.py         # 실시간 전략 팩토리
strategy_factory.py                 # 백테스트 전략 팩토리 (상위 디렉토리)
```

## SWING_TYPE 매핑

| SWING_TYPE | 백테스트 전략 | 실시간 거래 전략 |
|------------|---------------|------------------|
| A          | EMAStrategy | SingleEMAStrategy |
| B          | IchimokuStrategy | SingleEMAStrategy (TODO) |
| S          | SingleEMABacktestStrategy | SingleEMAStrategy |

---

## 단일 20EMA 실전 전략 (SingleEMAStrategy)

20일 지수이동평균(EMA)을 중심으로 추세 추종 매매를 수행하는 전략입니다.
분할 매수/매도를 지원하며, 장중 실시간 신호 기반으로 매매를 실행합니다.

### 사용 지표

| 지표 | 용도 |
|-----|------|
| EMA 20 | 단기 추세 판단, 매수/매도 기준선 |
| EMA 120 | 장기 추세 판단, 하락장 필터 |
| ADX / +DI / -DI | 추세 강도 및 방향 판단 |
| ATR (14) | 변동성 기반 손절선, 가격 가드레일 |
| OBV z-score | 거래량 기반 수급 강도 |
| 외국인 순매수 비율 | 기관 수급 강도 |

### 배치 스케줄

| 시간 | 배치 | 설명 |
|-----|------|------|
| 08:29 | `cache_warmup_job` | 지표 캐시 워밍업 (Redis) |
| 09:00~14:55 | `trade_job` | 장중 매수/매도 체크 (5분 간격) |

### SIGNAL 상태 흐름

```
SIGNAL 0 (대기)
    │
    ├─ 1차 매수 조건 충족 ──→ SIGNAL 1 (1차 매수 완료)
    │                            │
    │                            ├─ 2차 매수 조건 충족 ──→ SIGNAL 2 (2차 매수 완료)
    │                            │                            │
    │                            │                            └─ 장중 손절 ──→ SIGNAL 3 → SIGNAL 0
    │                            │
    │                            └─ 장중 손절 ──→ SIGNAL 3 (1차 손절 매도) ──→ SIGNAL 0
```

---

### 매수 전략

#### 하락장 필터
- 20 EMA가 120 EMA 아래에 있으면 매수 금지

#### 1차 매수
- 현재가가 EMA20 부근 (0.5% 여유)
- 외국인 수급 + OBV z-score 기준 충족
- 급등 필터 (5% 이하)
- EMA 괴리율 필터 (5% 이하)
- +DI > -DI (상승 추세)
- 연속 2회 확인 (10분)

#### 2차 매수
1차 매수 후 최소 20분 경과 시, 다음 두 시나리오 중 하나 충족 시 추가 매수

**시나리오 A - 추세 강화형**
- 가격: EMA + ATR × (0.3 ~ 2.0)
- ADX > 25 (강한 추세)
- 외국인 + OBV 수급 지속

**시나리오 B - 눌림목 반등**
- 가격: EMA ± ATR × 0.5
- ADX 18~23 (조정 구간)
- 장중 저가 대비 0.4% 반등

---

### 매도 전략

#### 장중 손절
- EMA - ATR × 1.0 이하로 하락 시 즉시 매도
- 1차 손절: `sell_ratio%` 매도 (SIGNAL 3)
- 2차 손절: 잔량 전량 매도 (SIGNAL 0)

---

## 단일 20EMA 백테스팅 전략 (SingleEMABacktestStrategy)

과거 데이터로 전략 성능을 검증하는 백테스팅 전략입니다.
실전 전략과 유사하지만, 일별 종가/저가 데이터를 기반으로 매도 신호를 생성합니다.

### 사용 지표

실전 전략과 동일 (EMA 20/120, ADX, +DI/-DI, ATR, OBV z-score)

### SIGNAL 상태 흐름

```
SIGNAL 0 (대기)
    │
    ├─ 1차 매수 조건 충족 ──→ SIGNAL 1 (1차 매수 완료)
    │                            │
    │                            ├─ 2차 매수 조건 충족 ──→ SIGNAL 2 (2차 매수 완료)
    │                            │                            │
    │                            │                            ├─ 장중 손절 ──→ SIGNAL 3 → SIGNAL 0
    │                            │                            └─ EOD 1차 매도 ──→ SELL_PRIMARY
    │                            │                                                    │
    │                            │                                                    ├─ EOD 2차 매도 ──→ SIGNAL 0
    │                            │                                                    └─ 추가 하락 -2% ──→ SIGNAL 0
    │                            │
    │                            └─ EOD 1차 매도 ──→ SELL_PRIMARY → SIGNAL 0
```

---

### 매수 전략

실전 전략과 동일 (하락장 필터, 1차/2차 매수 시나리오 A/B)

---

### 매도 전략

#### [1차 방어선] 장중 손절
- 일일 저가가 EMA - ATR × 1.0 이하로 하락 시 즉시 매도
- 전량 매도 (SIGNAL 0)

#### [2차 방어선] 장 마감 매도 (EOD 신호)
- 종가 기준으로 매도 신호 확정
- 시간 윈도우: 최근 3거래일 이내 발생한 신호만 유효

**3가지 EOD 신호:**
1. **EMA 이탈**: 종가 < EMA20
2. **추세 약화**: ADX < 20 AND -DI > +DI (2일 연속)
3. **수급 이탈**: OBV z-score < -1.0

**1차 분할 매도 (SELL_PRIMARY)**
- 3개 신호 중 2개 이상 충족 시
- `sell_ratio%` 매도, 잔량 보유

**2차 전량 매도 (SIGNAL 0)**
- 1차 매도 후, 다음 조건 중 하나라도 충족 시:
  - 3개 신호 모두 충족
  - 1차 매도가 대비 -2% 추가 하락

---

## 실전 전략 vs 백테스팅 전략 비교

| 구분 | 실전 전략 (SingleEMAStrategy) | 백테스팅 전략 (SingleEMABacktestStrategy) |
|------|-------------------------------|------------------------------------------|
| **데이터** | 실시간 5분 간격 체크 | 일별 OHLCV 데이터 |
| **배치 스케줄** | `trade_job` (09:00~14:55, 5분 간격) | 일별 계산 (백테스트 기간) |
| **1차 매수** | 동일 (하락장 필터, 5개 조건, 연속 2회) | 동일 (연속 1회) |
| **2차 매수** | 동일 (시나리오 A/B, 20분 경과) | 동일 (시나리오 A/B) |
| **장중 손절** | 실시간 현재가 기준 | 일일 저가 기준 |
| **EOD 매도** | ❌ 사용 안 함 | ✅ 사용 (3가지 신호, 시간 윈도우 3일) |
| **분할 매도** | ❌ 없음 (즉시 전량 매도) | ✅ 있음 (SELL_PRIMARY → SELL_ALL) |
| **SIGNAL 상태** | 0 → 1 → 2 → 3 → 0 | 0 → 1 → 2 → SELL_PRIMARY → 0 |
| **주요 목적** | 장중 실시간 매매 | 과거 데이터 성능 검증 |